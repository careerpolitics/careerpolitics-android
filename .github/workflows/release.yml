name: Release

on:
  # Immutable production releases are created from semantic-version tags only.
  push:
    tags:
      - 'v*.*.*'

# Least-privilege defaults; job-level override grants release write only where needed.
permissions:
  contents: read

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-and-release:
    name: Build signed AAB and publish GitHub Release
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: write
    env:
      # Inject app runtime config values from GitHub Secrets.
      GOOGLE_WEB_CLIENT_ID: ${{ secrets.GOOGLE_WEB_CLIENT_ID }}
      PUSHER_INSTANCE_ID: ${{ secrets.PUSHER_INSTANCE_ID }}
      # Use CI run number as a monotonic versionCode for tagged releases.
      CI_VERSION_CODE: ${{ github.run_number }}
      CI_VERSION_NAME: ${{ github.ref_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: gradle

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Ensure Gradle wrapper is executable
        run: chmod +x ./gradlew

      # Validate all required secrets before decoding files.
      - name: Validate release secrets
        env:
          GOOGLE_SERVICES_JSON_BASE64: ${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          for var in GOOGLE_SERVICES_JSON_BASE64 KEYSTORE_BASE64 KEYSTORE_PASSWORD KEY_ALIAS KEY_PASSWORD; do
            if [ -z "${!var}" ]; then
              echo "Missing required secret: ${var}" >&2
              exit 1
            fi
          done

      # Decode secret material just-in-time for the build.
      - name: Decode release files
        env:
          GOOGLE_SERVICES_JSON_BASE64: ${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "$GOOGLE_SERVICES_JSON_BASE64" | base64 --decode > app/google-services.json
          echo "$KEYSTORE_BASE64" | base64 --decode > app/release.keystore

      # Build signed release AAB using env-based signing config in app/build.gradle.kts.
      - name: Build release bundle
        env:
          KEYSTORE_PATH: release.keystore
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: ./gradlew --no-daemon clean bundleRelease

      # Publish immutable build outputs and obfuscation mapping.
      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ github.ref_name }}
          path: |
            app/build/outputs/bundle/release/*.aab
            app/build/outputs/mapping/release/mapping.txt
          if-no-files-found: error
          retention-days: 180

      # Create GitHub Release and attach release outputs.
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            app/build/outputs/bundle/release/*.aab
            app/build/outputs/mapping/release/mapping.txt

      # Always wipe decoded secrets from workspace after build.
      - name: Cleanup sensitive files
        if: always()
        run: rm -f app/google-services.json app/release.keystore
