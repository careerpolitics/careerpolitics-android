name: Android CI

on:
  # Run CI for every main branch push and for semver tag pushes.
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  # Allow manual reruns from the Actions tab.
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  JAVA_VERSION: '21'

jobs:
  ci:
    name: Lint, test, and smoke-build
    runs-on: ubuntu-latest

    steps:
      # Pull repository source code into the runner.
      - name: Checkout source
        uses: actions/checkout@v4

      # Install JDK 21 and enable built-in Gradle dependency cache.
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle

      # Install Android SDK commandline tools and required platform tools.
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      # Configure Gradle caching and build scan metadata.
      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Ensure Gradle wrapper is executable
        run: chmod +x ./gradlew

      # Decode Firebase config from GitHub secret into app/google-services.json.
      - name: Decode google-services.json
        env:
          GOOGLE_SERVICES_JSON_BASE64: ${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}
        run: |
          if [ -z "$GOOGLE_SERVICES_JSON_BASE64" ]; then
            echo "Missing required secret: GOOGLE_SERVICES_JSON_BASE64" >&2
            exit 1
          fi
          echo "$GOOGLE_SERVICES_JSON_BASE64" | base64 --decode > app/google-services.json

      # Static analysis for Android/Kotlin issues.
      - name: Run lint
        run: ./gradlew lint

      # JVM unit tests for debug variant.
      - name: Run unit tests
        run: ./gradlew testDebugUnitTest

      # Smoke build debug APK and AAB to detect packaging/signing regressions.
      - name: Build debug APK and AAB
        run: ./gradlew assembleDebug bundleDebug

      # Upload smoke artifacts for inspection.
      - name: Upload debug APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: app/build/outputs/apk/debug/app-debug.apk
          if-no-files-found: error
          retention-days: 14

      - name: Upload debug AAB
        uses: actions/upload-artifact@v4
        with:
          name: debug-aab
          path: app/build/outputs/bundle/debug/app-debug.aab
          if-no-files-found: error
          retention-days: 14

      # Always delete decoded secrets from runner workspace.
      - name: Cleanup generated secrets
        if: always()
        run: rm -f app/google-services.json
