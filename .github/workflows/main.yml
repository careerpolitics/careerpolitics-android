name: Main Branch Build

on:
  # Run on direct updates to main.
  push:
    branches:
      - main

permissions: read-all

concurrency:
  group: main-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  JAVA_VERSION: '21'

jobs:
  validate-and-release:
    name: Validate, build signed artifacts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Gradle caching
        uses: gradle/actions/setup-gradle@v4

      - name: Ensure gradlew executable
        run: chmod +x ./gradlew

      # Validate required secrets for signed release builds.
      - name: Validate required secrets
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          GOOGLE_SERVICES_JSON_BASE64: ${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}
        run: |
          for var in KEYSTORE_BASE64 KEYSTORE_PASSWORD KEY_ALIAS KEY_PASSWORD GOOGLE_SERVICES_JSON_BASE64; do
            if [ -z "${!var}" ]; then
              echo "Missing required secret: $var" >&2
              exit 1
            fi
          done

      - name: Decode keystore and google-services.json
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          GOOGLE_SERVICES_JSON_BASE64: ${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 --decode > app/release.keystore
          echo "$GOOGLE_SERVICES_JSON_BASE64" | base64 --decode > app/google-services.json

      # Same validation gates as PR.
      - name: Clean
        run: ./gradlew clean --stacktrace

      - name: Lint
        run: ./gradlew lint --stacktrace

      - name: Unit tests
        run: ./gradlew testDebugUnitTest --stacktrace

      - name: Smoke build debug APK and AAB
        run: ./gradlew assembleDebug bundleDebug --stacktrace

      # Signed release outputs for distribution.
      - name: Build signed release APK and AAB
        env:
          KEYSTORE_PATH: release.keystore
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: ./gradlew assembleRelease bundleRelease --stacktrace

      - name: Upload lint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: main-lint-report
          path: app/build/reports/lint-results*.html
          if-no-files-found: warn

      - name: Upload unit test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: main-unit-test-reports
          path: |
            app/build/reports/tests/testDebugUnitTest/**
            app/build/test-results/testDebugUnitTest/**
          if-no-files-found: warn

      - name: Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: main-debug-builds
          path: |
            app/build/outputs/apk/debug/app-debug.apk
            app/build/outputs/bundle/debug/app-debug.aab
          if-no-files-found: warn

      - name: Upload signed release APK
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: main-release-apk
          path: app/build/outputs/apk/release/app-release.apk
          if-no-files-found: warn

      - name: Upload signed release AAB
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: main-release-aab
          path: app/build/outputs/bundle/release/app-release.aab
          if-no-files-found: warn

      - name: Upload ProGuard mapping
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: main-release-mapping
          path: app/build/outputs/mapping/release/mapping.txt
          if-no-files-found: warn

      - name: Cleanup sensitive files
        if: always()
        run: rm -f app/release.keystore app/google-services.json

  deploy-internal:
    name: Deploy to Google Play Internal
    runs-on: ubuntu-latest
    needs: validate-and-release
    if: success() && secrets.SERVICE_ACCOUNT_JSON_BASE64 != ''

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Decode service account
        env:
          SERVICE_ACCOUNT_JSON_BASE64: ${{ secrets.SERVICE_ACCOUNT_JSON_BASE64 }}
        run: echo "$SERVICE_ACCOUNT_JSON_BASE64" | base64 --decode > service-account.json

      - name: Download release AAB
        uses: actions/download-artifact@v4
        with:
          name: main-release-aab
          path: dist

      - name: Upload to internal track
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJson: service-account.json
          packageName: com.murari.careerpolitics
          releaseFiles: dist/app-release.aab
          track: internal
          status: completed

      - name: Cleanup service account
        if: always()
        run: rm -f service-account.json
