name: Android CI

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop, "feature/**"]
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: android-ci-${{ github.ref }}
  cancel-in-progress: true

env:
  JAVA_VERSION: "21"
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true"

jobs:
  versioning:
    name: Versioning automation
    runs-on: ubuntu-latest
    outputs:
      version_name: ${{ steps.version.outputs.version_tag }}
      version_code: ${{ steps.meta.outputs.version_code }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate semantic version
        id: version
        uses: paulhatch/semantic-version@v5.4.0
        with:
          tag_prefix: "v"
          major_pattern: "(MAJOR|BREAKING CHANGE)"
          minor_pattern: "(MINOR|feat:)"
          version_format: "${major}.${minor}.${patch}"

      - name: Generate build metadata
        id: meta
        run: |
          VERSION_CODE=$((10000 + GITHUB_RUN_NUMBER))
          echo "version_code=${VERSION_CODE}" >> "$GITHUB_OUTPUT"
          cat <<JSON > version-metadata.json
          {
            "versionName": "${{ steps.version.outputs.version_tag }}",
            "versionCode": ${VERSION_CODE},
            "gitSha": "${{ github.sha }}",
            "runNumber": "${{ github.run_number }}"
          }
          JSON

      - name: Upload version metadata
        uses: actions/upload-artifact@v4
        with:
          name: version-metadata
          path: version-metadata.json
          retention-days: 90

      - name: Create/update version tag (main branch)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          TAG="v${{ steps.version.outputs.version_tag }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -f "$TAG" "${{ github.sha }}"
          git push origin "$TAG" --force

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: [versioning]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: Run detekt + android lint
        run: ./gradlew detekt lintDebug

      - name: Upload lint reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-reports
          path: |
            **/build/reports/detekt/**
            **/build/reports/lint-results-*.html
            **/build/reports/lint-results-*.xml
          retention-days: 14

  unit-tests:
    name: Unit tests
    runs-on: ubuntu-latest
    needs: [versioning]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: Run unit tests
        run: ./gradlew testDebugUnitTest

      - name: Upload unit test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-reports
          path: |
            **/build/test-results/testDebugUnitTest/**
            **/build/reports/tests/testDebugUnitTest/**
          retention-days: 14

  build-debug:
    name: Debug build
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: Build debug APK
        run: ./gradlew assembleDebug
        env:
          PUSHER_INSTANCE_ID: ${{ secrets.PUSHER_INSTANCE_ID }}

      - name: Upload debug artifacts
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: |
            app/build/outputs/apk/debug/*.apk
            app/build/outputs/mapping/debug/**
          retention-days: 30

  build-release:
    name: Release build
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: Prepare signing keystore
        shell: bash
        run: |
          mkdir -p ci
          if [[ -n "${{ secrets.KEYSTORE_BASE64 }}" ]]; then
            echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > ci/release.keystore
            echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> "$GITHUB_ENV"
            echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> "$GITHUB_ENV"
            echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> "$GITHUB_ENV"
          else
            keytool -genkeypair -v \
              -keystore ci/release.keystore \
              -alias ci \
              -storepass android \
              -keypass android \
              -keyalg RSA \
              -keysize 2048 \
              -validity 3650 \
              -dname "CN=CI,O=CareerPolitics,C=US"
            echo "KEYSTORE_PASSWORD=android" >> "$GITHUB_ENV"
            echo "KEY_ALIAS=ci" >> "$GITHUB_ENV"
            echo "KEY_PASSWORD=android" >> "$GITHUB_ENV"
          fi

      - name: Build release APK + AAB
        run: ./gradlew assembleRelease bundleRelease
        env:
          PUSHER_INSTANCE_ID: ${{ secrets.PUSHER_INSTANCE_ID }}
          KEYSTORE_PATH: ci/release.keystore
          KEYSTORE_PASSWORD: ${{ env.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ env.KEY_ALIAS }}
          KEY_PASSWORD: ${{ env.KEY_PASSWORD }}

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: |
            app/build/outputs/apk/release/*.apk
            app/build/outputs/bundle/release/*.aab
            app/build/outputs/mapping/release/mapping.txt
          retention-days: 90

      - name: Cleanup signing material
        if: always()
        run: rm -f ci/release.keystore
